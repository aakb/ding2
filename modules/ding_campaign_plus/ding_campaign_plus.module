<?php
/**
 * @file
 * Code for the Ding Campaign Plus feature.
 */

include_once 'ding_campaign_plus.features.inc';

// Load the files need to generate the trigger tabs in the administration form.
// Sadly they need to be include here an not in the alter function. If not
// include here the ajax (add another etc.) will not work.
include_once 'includes/ding_campaign_plus_other.admin.inc';
include_once 'includes/ding_campaign_plus_search.admin.inc';

/**
 * Implements hook_menu().
 */
function ding_campaign_plus_menu() {
  $items = array();

  $items['ding_campaign_plus/autocomplete/%'] = array(
    'title' => 'Campaign rule autocomplete',
    'description' => 'Auto complete field for campaign rule values.',
    'page callback' => '_ding_campaign_plus_other_admin_autocomplete',
    'page arguments' => array(2),
    'access arguments' => array('access campaign plus triggers'),
    'file' => 'includes/ding_campaign_plus_other.admin.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function ding_campaign_plus_permission() {
  return array(
    'access campaign plus triggers' => array(
      'title' => t('Access campaign plus triggers'),
      'description' => t('Access to define campaign rules'),
    ),
  );
}


/**
 * Implements hook_form_FORM_ID_alter().
 */
function ding_campaign_plus_form_ding_campaign_plus_node_form_alter(&$form, &$form_state) {

  // Defines tab one.
  $path = drupal_get_path('module', 'field_group');
  $form['triggers'] = array(
    '#type' => 'fieldset',
    '#title' => t('Campaign trigger'),
    '#weight' => 10,
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#attached' => array(
      'js' => array(
        $path . '/horizontal-tabs/horizontal-tabs.js',
      ),
      'css' => array(
        $path . '/horizontal-tabs/horizontal-tabs.css',
      ),
    ),
  );

  $form['triggers']['tabs'] = array(
    '#type' => 'horizontal_tabs',
    '#tree' => TRUE,
  );

  // Defines search results tab.
  $form['triggers']['tabs']['search'] = array(
    '#type' => 'fieldset',
    '#title' => t('Search result'),
    'rules' => _ding_campaign_plus_search_triggers_form($form, $form_state),
  );

  // Defines other trigger methods (old ding campaign triggers).
  $form['triggers']['tabs']['other'] = array(
    '#type' => 'fieldset',
    '#title' => t('Other triggers'),
    'rules' => _ding_campaign_plus_other_triggers_form($form, $form_state),
  );

  // Ensures that is comes after the triggers when rendered.
  $form['field_ding_campaign_plus_track']['#weight'] = 11;

  // Add submit handler for the triggers.
  array_unshift($form['actions']['submit']['#submit'], '_ding_campaign_plus_other_triggers_form_submit');
}
